<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phase 1 Local Accountability Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --navy: #0a355e;
      --teal: #0e8577;
      --gold: #dbb550;
      --bg: #f4f6fb;
      --card-bg: #ffffff;
      --border-soft: #dde3ee;
      --text: #111111;
      --muted: #70747a;
      --danger: #b74b4b;
      --success: #1e8a4b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #fdf7e7, #f4f6fb);
      color: var(--text);
    }

    .page {
      max-width: 960px;
      margin: 16px auto 40px;
      padding: 0 16px 24px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .brand-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--navy);
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      min-width: 240px;
    }

    .selector-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    label {
      font-size: 11px;
      color: var(--muted);
    }

    select {
      font-family: inherit;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 10px;
      background: #f9fafc;
      color: var(--text);
    }

    select:focus {
      outline: none;
      border-color: var(--teal);
      box-shadow: 0 0 0 1px rgba(14, 133, 119, 0.25);
    }

    .btn-pill {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 5px 12px;
      font-size: 12px;
      background: #ffffff;
      color: var(--navy);
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(10, 53, 94, 0.08);
    }

    .btn-pill.primary {
      background: linear-gradient(to right, var(--navy), var(--teal));
      color: #ffffff;
      border-color: transparent;
    }

    .btn-pill:hover { opacity: 0.96; }

    .tagline {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
      max-width: 700px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 10px 12px 12px;
      box-shadow: 0 5px 16px rgba(9, 30, 66, 0.04);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 650;
      color: var(--navy);
    }

    .chip {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(10, 53, 94, 0.2);
      background: #f7f8fd;
      color: var(--muted);
      white-space: nowrap;
    }

    .section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .gauges-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .gauge {
      flex: 1 1 130px;
      min-width: 130px;
    }

    .gauge-label-row {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      margin-bottom: 2px;
      color: var(--muted);
    }

    .gauge-name {
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .gauge-value {
      font-weight: 600;
      color: var(--navy);
    }

    .gauge-bar {
      position: relative;
      height: 8px;
      border-radius: 999px;
      background: #e5e9f3;
      overflow: hidden;
    }

    .gauge-fill {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 50%;
      background: linear-gradient(to right, var(--teal), var(--gold));
      border-radius: 999px;
      transition: width 0.25s ease-out;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      flex-wrap: wrap;
      gap: 4px;
    }

    .pill-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(10, 53, 94, 0.18);
      background: #f7f8fd;
      font-size: 11px;
      color: var(--navy);
    }

    .role-note {
      font-size: 11px;
      color: var(--muted);
      margin: 4px 0 6px;
    }

    .scenario-title {
      font-size: 14px;
      font-weight: 650;
      color: var(--navy);
      margin-bottom: 4px;
    }

    .scenario-meta {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .scenario-text {
      font-size: 13px;
      margin-bottom: 6px;
    }

    .option-group {
      margin: 6px 0 8px;
    }

    .option {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 13px;
      cursor: pointer;
    }

    .option input[type="radio"] {
      margin-top: 2px;
      accent-color: var(--teal);
    }

    .helper-text {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .dropdown-row {
      margin: 6px 0 8px;
    }

    .dropdown-row select {
      width: 100%;
    }

    input[type="text"] {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      background: #f9fafc;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--teal);
      box-shadow: 0 0 0 1px rgba(14, 133, 119, 0.25);
    }

    .feedback {
      margin-top: 6px;
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
      display: none;
    }

    .feedback.success {
      border-left: 3px solid var(--success);
      background: #f2fbf6;
      color: #155634;
    }

    .feedback.warn {
      border-left: 3px solid var(--danger);
      background: #fef5f5;
      color: #7f3131;
    }

    .feedback.neutral {
      border-left: 3px solid var(--navy);
      background: #eef2fb;
      color: var(--navy);
    }

    .scenario-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .link-button {
      font-size: 12px;
      color: var(--teal);
      cursor: pointer;
      text-decoration: underline;
      background: none;
      border: none;
      padding: 0;
    }

    /* Drag and drop board */
    .board {
      margin-top: 8px;
      border-radius: 10px;
      border: 1px dashed var(--border-soft);
      padding: 6px;
      background: #f9fafc;
    }

    .board-header {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .board-columns {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    .board-column {
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 4px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .board-column-title {
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 2px;
      font-size: 11px;
    }

    .card-draggable {
      background: #f4f6fd;
      border-radius: 6px;
      border: 1px solid #d1d7ea;
      padding: 4px 6px;
      font-size: 11px;
      cursor: move;
    }

    .board-column.drop-hover {
      border-color: var(--teal);
      background: #ecf8f6;
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div>
      <div class="brand-title">Phase 1 Local Accountability Simulator</div>
      <div class="brand-subtitle">Practice real decisions before you make them live.</div>
    </div>
    <div class="controls">
      <div class="selector-row">
        <div>
          <label for="roleSelect">Stakeholder</label><br />
          <select id="roleSelect">
            <option value="districtLeader">Superintendent / District Leader</option>
            <option value="schoolLeader">Principal / School Leader</option>
            <option value="teacher">Teacher</option>
            <option value="student">Student</option>
            <option value="parent">Parent / Guardian</option>
            <option value="boardMember">Board Member</option>
            <option value="communityMember">Community Member</option>
          </select>
        </div>
        <div>
          <label>Phase</label><br />
          <div class="chip">Phase 1. Laying the Groundwork</div>
        </div>
      </div>
      <div class="selector-row">
        <button class="btn-pill primary" id="startBtn">Start or Resume</button>
        <button class="btn-pill" id="resetBtn">Reset</button>
      </div>
    </div>
  </header>

  <div class="tagline">
    Move through a short sequence of decisions that mirror Phase 1. Your choices shift Trust, Clarity, and Coherence for your chosen stakeholder.
    One step at a time. No technical knowledge needed.
  </div>

  <section class="card">
    <div class="card-header">
      <div class="card-title">Step by Step Simulation</div>
      <span class="chip" id="stepChip">Step 0 of 4</span>
    </div>

    <div class="section-label">System gauges</div>
    <div class="gauges-row">
      <div class="gauge">
        <div class="gauge-label-row">
          <span class="gauge-name">Trust</span>
          <span class="gauge-value" id="trustValue">50</span>
        </div>
        <div class="gauge-bar">
          <div class="gauge-fill" id="trustGauge"></div>
        </div>
      </div>
      <div class="gauge">
        <div class="gauge-label-row">
          <span class="gauge-name">Clarity</span>
          <span class="gauge-value" id="clarityValue">50</span>
        </div>
        <div class="gauge-bar">
          <div class="gauge-fill" id="clarityGauge"></div>
        </div>
      </div>
      <div class="gauge">
        <div class="gauge-label-row">
          <span class="gauge-name">Coherence</span>
          <span class="gauge-value" id="coherenceValue">50</span>
        </div>
        <div class="gauge-bar">
          <div class="gauge-fill" id="coherenceGauge"></div>
        </div>
      </div>
    </div>

    <div class="meta-row">
      <span id="scenarioMetaLabel">Phase 1 orientation</span>
      <span class="pill-tag" id="roleTag">Perspective: Superintendent / District Leader</span>
    </div>
    <div class="role-note" id="roleNote">
      You are seeing Phase 1 through the district lens. Watch how the gauges move as you make choices.
    </div>

    <hr style="border:none;border-top:1px solid var(--border-soft);margin:6px 0 8px;" />

    <div id="scenarioContainer">
      <!-- scenario content will be rendered here -->
      <div class="scenario-title">Welcome to the simulator</div>
      <div class="scenario-meta">Orientation</div>
      <div class="scenario-text">
        When you are ready, select Start or Resume to move into Step 1. You will see one decision at a time with simple options.
        There are no right answers. The goal is to notice how early choices shape trust, clarity, and coherence.
      </div>
    </div>

    <div id="feedbackBox" class="feedback neutral"></div>

    <div class="scenario-footer">
      <button class="link-button" id="backBtn">Previous step</button>
      <button class="btn-pill" id="continueBtn">Continue</button>
    </div>
  </section>
</div>

<script>
  // --------------------------------------------------------------------
  // 1. CORE STATE MODEL (GAUGES, ROLE, HISTORY)
  // --------------------------------------------------------------------

  const simState = {
    role: "districtLeader",
    currentScenarioId: "intro",
    stepIndex: 0,
    totalSteps: 4,
    gauges: {
      trust: 50,
      clarity: 50,
      coherence: 50
    },
    // history stores what the user chose. This can be sent to AI in the background.
    history: []
  };

  const roleLabels = {
    districtLeader: "Superintendent / District Leader",
    schoolLeader: "Principal / School Leader",
    teacher: "Teacher",
    student: "Student",
    parent: "Parent / Guardian",
    boardMember: "Board Member",
    communityMember: "Community Member"
  };

  const roleNotes = {
    districtLeader: "You are seeing Phase 1 through the district lens. Watch how the gauges move as you make choices.",
    schoolLeader: "You are seeing Phase 1 through a school lens. Notice how each choice will land with staff and families.",
    teacher: "You are seeing Phase 1 through the classroom lens. Watch when decisions clear space for good teaching and when they add clutter.",
    student: "You are seeing Phase 1 as a student. Notice when your experience is centered and when adults talk about you instead of with you.",
    parent: "You are seeing Phase 1 as a parent or guardian. Notice how communication and respect shape your trust.",
    boardMember: "You are seeing Phase 1 as a board member. Watch when you would feel confident supporting this work and when you would want more clarity.",
    communityMember: "You are seeing Phase 1 as a community member or partner. Notice how the work connects to readiness for life, work, and citizenship."
  };

  // --------------------------------------------------------------------
  // 2. LOCAL SCENARIO DEFINITIONS (DEFAULT CONTENT)
  // --------------------------------------------------------------------
  // These are safe default scenarios. Later, AI can override or extend them.

  const localScenarios = {
    intro: {
      id: "intro",
      step: 0,
      title: "Welcome to the simulator",
      metaByRole(role) {
        return "A simple, four step walkthrough of Phase 1 decisions.";
      },
      textByRole(role) {
        return "You will move through a short sequence of decisions that mirror how Phase 1 might feel in your district. There are no points or grades. The goal is to build shared understanding and better decisions.";
      },
      type: "info",
      nextId: "launch"
    },
    launch: {
      id: "launch",
      step: 1,
      title: "Launching Phase 1",
      metaByRole(role) {
        if (role === "teacher") {
          return "How this is introduced will shape whether you see Phase 1 as helpful or as one more thing.";
        }
        if (role === "parent") {
          return "You receive many district messages. You want to know if this one matters for your child.";
        }
        return "You are preparing to introduce Phase 1 to your system. Staff, families, and board members are paying attention.";
      },
      textByRole(role) {
        return "You can choose a quick, light launch. You can slow down to build partners. Or you can wait until everything is perfect. Each path has tradeoffs.";
      },
      type: "choice",
      options: [
        {
          id: "launch_email",
          label: "Send a short email and attached overview. Ask principals to follow up in their own way.",
          effects: { trust: -4, clarity: -2, coherence: +2 },
          feedback: "People get basic information, but it may feel like one more initiative in the inbox."
        },
        {
          id: "launch_partners",
          label: "Host a short launch with principals, teacher leaders, and LAAC candidates first. Then send a refined message to staff and families.",
          effects: { trust: +6, clarity: +5, coherence: +4 },
          feedback: "You slow down enough to build partners. The message feels more shared and less top down."
        },
        {
          id: "launch_wait",
          label: "Wait until every tool is perfect before saying anything. Announce only when everything is finished.",
          effects: { trust: -2, clarity: -3, coherence: -2 },
          feedback: "You avoid early questions, but people may sense that something is happening without them."
        }
      ],
      nextId: "laac"
    },
    laac: {
      id: "laac",
      step: 2,
      title: "Forming the Advisory Council (LAAC)",
      metaByRole(role) {
        return "Who you invite into the LAAC will quietly define whose voice counts in this work.";
      },
      textByRole(role) {
        return "You have room for 12 to 18 members. You want students, families, staff, leaders, a board representative, and community voices. Time is limited, and people are busy.";
      },
      type: "dropdown",
      choices: [
        {
          id: "laac_existing",
          label: "Invite people from existing committees and task forces only.",
          effects: { trust: -3, clarity: 0, coherence: +3 },
          feedback: "Efficient, but the group may feel like the same insiders who always meet."
        },
        {
          id: "laac_blend",
          label: "Blend invitations with open calls, reserving seats for students, families, staff, and community.",
          effects: { trust: +7, clarity: +3, coherence: +4 },
          feedback: "More effort, but the LAAC looks and feels like the community it serves."
        },
        {
          id: "laac_principal",
          label: "Ask each principal to choose one representative from their school without set criteria.",
          effects: { trust: -2, clarity: -2, coherence: -3 },
          feedback: "You move fast, but representation may be uneven and hard to explain."
        }
      ],
      nextId: "evidence"
    },
    evidence: {
      id: "evidence",
      step: 3,
      title: "Choosing Evidence of Current Conditions",
      metaByRole(role) {
        if (role === "teacher") {
          return "You know test scores alone do not show what students can really do.";
        }
        return "The evidence you choose becomes the story the LAAC and board will see about your system.";
      },
      textByRole(role) {
        return "You can lean on familiar metrics only. Or you can invite more authentic evidence of teaching and learning.";
      },
      type: "choice",
      options: [
        {
          id: "evidence_minimal",
          label: "Ask schools for test scores, attendance, and discipline data only.",
          effects: { trust: -2, clarity: -3, coherence: +1 },
          feedback: "Simple to collect, but many teachers and families will feel that key parts of learning are missing."
        },
        {
          id: "evidence_balanced",
          label: "Ask for test data, sample units, student work, student and family feedback, and short walkthrough notes.",
          effects: { trust: +5, clarity: +6, coherence: +4 },
          feedback: "More work, but it gives a fuller, more honest picture of learning in your district."
        },
        {
          id: "evidence_bestlight",
          label: "Tell schools to send whatever shows them in the best light.",
          effects: { trust: -3, clarity: -4, coherence: -2 },
          feedback: "You may see polished highlights, but gaps and struggles remain invisible."
        }
      ],
      nextId: "priorities"
    },
    priorities: {
      id: "priorities",
      step: 4,
      title: "Prioritizing What Happens Next",
      metaByRole(role) {
        return "You have early evidence and a first sense of readiness. Now you decide what happens first.";
      },
      textByRole(role) {
        return "Drag each card into Do Now, Do Next, or Park for Later. There is no perfect pattern. The goal is to see your instincts.";
      },
      type: "board",
      board: {
        columns: [
          { id: "do_now", label: "Do Now" },
          { id: "do_next", label: "Do Next" },
          { id: "park", label: "Park for Later" }
        ],
        cards: [
          { id: "card_rubric", text: "Co design a simple readiness rubric with the LAAC and principals." },
          { id: "card_summary", text: "Draft a one page School Summary Profile template for each school." },
          { id: "card_voice", text: "Create a way for students to share how current assessments feel to them." },
          { id: "card_families", text: "Send a short, clear message to families about what Phase 1 is and is not." }
        ]
      },
      // gauge effects based on layout will be calculated in code
      nextId: null
    }
  };

  // --------------------------------------------------------------------
  // 3. AI HOOKS - HIDDEN BACKGROUND PROMPTING (NO UI)
  // --------------------------------------------------------------------
  // This is where you would integrate with an AI service.
  // For now, the simulator uses localScenarios above.
  // Later, you can flip useAI to true and wire requestNextScenarioFromAI
  // to your own backend that calls an AI model.

  const useAI = false; // switch to true when you have a backend ready

  function buildAIContext() {
    // Build a structured payload with role, gauges, and history.
    // This can be sent to a backend AI service.
    return {
      role: simState.role,
      role_label: roleLabels[simState.role],
      phase: "phase1",
      gauges: simState.gauges,
      history: simState.history
    };
  }

  async function requestNextScenarioFromAI(currentScenarioId) {
    // Example only. Replace this with a real API call in your environment.
    // const payload = buildAIContext();
    // const response = await fetch("/api/phase1-next-scenario", {
    //   method: "POST",
    //   headers: { "Content-Type": "application/json" },
    //   body: JSON.stringify(payload)
    // });
    // const data = await response.json();
    // return data; // data should be a scenario object similar to localScenarios entries

    // For now, just fall back to local scenarios.
    return localScenarios[currentScenarioId];
  }

  // --------------------------------------------------------------------
  // 4. DOM REFERENCES
  // --------------------------------------------------------------------

  const roleSelectEl = document.getElementById("roleSelect");
  const stepChipEl = document.getElementById("stepChip");

  const trustGaugeEl = document.getElementById("trustGauge");
  const clarityGaugeEl = document.getElementById("clarityGauge");
  const coherenceGaugeEl = document.getElementById("coherenceGauge");

  const trustValueEl = document.getElementById("trustValue");
  const clarityValueEl = document.getElementById("clarityValue");
  const coherenceValueEl = document.getElementById("coherenceValue");

  const scenarioMetaLabelEl = document.getElementById("scenarioMetaLabel");
  const roleTagEl = document.getElementById("roleTag");
  const roleNoteEl = document.getElementById("roleNote");
  const scenarioContainerEl = document.getElementById("scenarioContainer");
  const feedbackBoxEl = document.getElementById("feedbackBox");

  const startBtnEl = document.getElementById("startBtn");
  const resetBtnEl = document.getElementById("resetBtn");
  const continueBtnEl = document.getElementById("continueBtn");
  const backBtnEl = document.getElementById("backBtn");

  // --------------------------------------------------------------------
  // 5. UI HELPERS
  // --------------------------------------------------------------------

  function clamp(value, min, max) {
    return Math.min(Math.max(value, min), max);
  }

  function updateGauges() {
    trustGaugeEl.style.width = simState.gauges.trust + "%";
    clarityGaugeEl.style.width = simState.gauges.clarity + "%";
    coherenceGaugeEl.style.width = simState.gauges.coherence + "%";

    trustValueEl.textContent = simState.gauges.trust;
    clarityValueEl.textContent = simState.gauges.clarity;
    coherenceValueEl.textContent = simState.gauges.coherence;
  }

  function updateRoleUI() {
    roleTagEl.textContent = "Perspective: " + (roleLabels[simState.role] || "Role");
    roleNoteEl.textContent = roleNotes[simState.role] || "";
  }

  function updateStepChip(step) {
    stepChipEl.textContent = "Step " + step + " of " + simState.totalSteps;
  }

  function showFeedback(message, tone) {
    feedbackBoxEl.style.display = "block";
    feedbackBoxEl.textContent = message;
    feedbackBoxEl.className = "feedback " + (tone || "neutral");
  }

  function clearFeedback() {
    feedbackBoxEl.style.display = "none";
    feedbackBoxEl.textContent = "";
    feedbackBoxEl.className = "feedback neutral";
  }

  function enableBoardDragAndDrop() {
    let dragCardId = null;
    const cards = scenarioContainerEl.querySelectorAll(".card-draggable");
    const columns = scenarioContainerEl.querySelectorAll(".board-column");

    cards.forEach(card => {
      card.addEventListener("dragstart", () => {
        dragCardId = card.dataset.cardId;
      });
      card.addEventListener("dragend", () => {
        dragCardId = null;
      });
    });

    columns.forEach(col => {
      col.addEventListener("dragover", e => {
        e.preventDefault();
        col.classList.add("drop-hover");
      });
      col.addEventListener("dragleave", () => {
        col.classList.remove("drop-hover");
      });
      col.addEventListener("drop", e => {
        e.preventDefault();
        col.classList.remove("drop-hover");
        if (!dragCardId) return;
        const card = scenarioContainerEl.querySelector('[data-card-id="' + dragCardId + '"]');
        if (card) col.appendChild(card);
      });
    });
  }

  function getBoardLayout() {
    const layout = {};
    const columns = scenarioContainerEl.querySelectorAll(".board-column");
    columns.forEach(col => {
      const id = col.dataset.columnId;
      layout[id] = [];
      col.querySelectorAll(".card-draggable").forEach(card => {
        layout[id].push(card.dataset.cardId);
      });
    });
    return layout;
  }

  // --------------------------------------------------------------------
  // 6. RENDER SCENARIOS
  // --------------------------------------------------------------------

  function renderScenario(scenarioId) {
    const scenario = localScenarios[scenarioId];
    if (!scenario) return;

    simState.currentScenarioId = scenarioId;
    simState.stepIndex = scenario.step || 0;
    updateStepChip(simState.stepIndex);
    clearFeedback();

    const metaText = scenario.metaByRole ? scenario.metaByRole(simState.role) : "Phase 1 decision";
    const bodyText = scenario.textByRole ? scenario.textByRole(simState.role) : "";

    scenarioMetaLabelEl.textContent = metaText;

    let html = "";
    html += `<div class="scenario-title">${scenario.title}</div>`;
    html += `<div class="scenario-meta">${metaText}</div>`;
    html += `<div class="scenario-text">${bodyText}</div>`;

    if (scenario.type === "choice") {
      html += `<div class="option-group">`;
      scenario.options.forEach((opt, idx) => {
        html += `
          <label class="option">
            <input type="radio" name="scenarioOption" value="${opt.id}" ${idx === 0 ? "checked" : ""}>
            <span>${opt.label}</span>
          </label>
        `;
      });
      html += `<div class="helper-text">Choose the option that is closest to how you would proceed.</div>`;
      html += `</div>`;
    }

    if (scenario.type === "dropdown") {
      html += `<div class="dropdown-row">
        <select id="scenarioDropdown">
          <option value="">Choose an approach...</option>
      `;
      scenario.choices.forEach(choice => {
        html += `<option value="${choice.id}">${choice.label}</option>`;
      });
      html += `</select>
        <div class="helper-text">Your choice will shape who feels represented in this work.</div>
      </div>`;
    }

    if (scenario.type === "board") {
      const board = scenario.board;
      html += `
        <div class="board">
          <div class="board-header">
            Drag each card into Do Now, Do Next, or Park for Later.
          </div>
          <div class="board-columns">
      `;
      board.columns.forEach(col => {
        html += `<div class="board-column" data-column-id="${col.id}">
          <div class="board-column-title">${col.label}</div>
        `;
        if (col.id === "do_now") {
          board.cards.forEach(card => {
            html += `<div class="card-draggable" draggable="true" data-card-id="${card.id}">${card.text}</div>`;
          });
        }
        html += `</div>`;
      });
      html += `</div></div>`;
    }

    scenarioContainerEl.innerHTML = html;
    if (scenario.type === "board") enableBoardDragAndDrop();
  }

  // --------------------------------------------------------------------
  // 7. HANDLE CHOICES AND BRANCHING
  // --------------------------------------------------------------------

  function applyEffects(effects) {
    if (!effects) return;
    simState.gauges.trust = clamp(simState.gauges.trust + (effects.trust || 0), 0, 100);
    simState.gauges.clarity = clamp(simState.gauges.clarity + (effects.clarity || 0), 0, 100);
    simState.gauges.coherence = clamp(simState.gauges.coherence + (effects.coherence || 0), 0, 100);
    updateGauges();
  }

  function handleContinue() {
    const scenario = localScenarios[simState.currentScenarioId];
    if (!scenario) return;

    if (scenario.type === "info") {
      simState.history.push({ scenarioId: "intro", choiceId: null, effects: {} });
      renderScenario(scenario.nextId);
      return;
    }

    if (scenario.type === "choice") {
      const checked = scenarioContainerEl.querySelector("input[name='scenarioOption']:checked");
      if (!checked) {
        showFeedback("Please select an option to continue.", "warn");
        return;
      }
      const optId = checked.value;
      const opt = scenario.options.find(o => o.id === optId);
      if (!opt) {
        showFeedback("There was an issue with that selection. Try again.", "warn");
        return;
      }
      applyEffects(opt.effects);
      showFeedback(opt.feedback, (opt.effects.trust + opt.effects.clarity + opt.effects.coherence) >= 0 ? "success" : "warn");
      simState.history.push({
        scenarioId: scenario.id,
        choiceId: opt.id,
        choiceLabel: opt.label,
        effects: opt.effects
      });
      if (scenario.nextId) {
        renderScenario(scenario.nextId);
      }
      return;
    }

    if (scenario.type === "dropdown") {
      const dropdown = scenarioContainerEl.querySelector("#scenarioDropdown");
      if (!dropdown || !dropdown.value) {
        showFeedback("Choose an approach to forming the LAAC before continuing.", "warn");
        return;
      }
      const choiceId = dropdown.value;
      const choice = scenario.choices.find(c => c.id === choiceId);
      if (!choice) {
        showFeedback("There was an issue with that selection. Try again.", "warn");
        return;
      }
      applyEffects(choice.effects);
      showFeedback(choice.feedback, (choice.effects.trust + choice.effects.clarity + choice.effects.coherence) >= 0 ? "success" : "warn");
      simState.history.push({
        scenarioId: scenario.id,
        choiceId: choice.id,
        choiceLabel: choice.label,
        effects: choice.effects
      });
      if (scenario.nextId) {
        renderScenario(scenario.nextId);
      }
      return;
    }

    if (scenario.type === "board") {
      const layout = getBoardLayout();
      const doNowCount = (layout.do_now || []).length;
      const doNextCount = (layout.do_next || []).length;
      const effects = {
        trust: doNowCount >= 2 ? +3 : -1,
        clarity: doNowCount + doNextCount >= 3 ? +4 : -2,
        coherence: doNowCount >= 2 ? +4 : 0
      };
      applyEffects(effects);
      simState.history.push({
        scenarioId: scenario.id,
        choiceId: "board_layout",
        choiceLabel: JSON.stringify(layout),
        effects
      });
      showFeedback("You have completed this short simulation. Use what you noticed as you plan real Phase 1 work.", "success");
      return;
    }
  }

  function handleBack() {
    if (simState.history.length === 0) {
      showFeedback("You are at the start of the simulation.", "neutral");
      return;
    }
    const last = simState.history.pop();
    simState.gauges.trust = clamp(simState.gauges.trust - (last.effects.trust || 0), 0, 100);
    simState.gauges.clarity = clamp(simState.gauges.clarity - (last.effects.clarity || 0), 0, 100);
    simState.gauges.coherence = clamp(simState.gauges.coherence - (last.effects.coherence || 0), 0, 100);
    updateGauges();
    renderScenario(last.scenarioId);
    showFeedback("You stepped back one decision. Adjust your choice if needed.", "neutral");
  }

  function resetSimulation() {
    simState.currentScenarioId = "intro";
    simState.stepIndex = 0;
    simState.history = [];
    simState.gauges = { trust: 50, clarity: 50, coherence: 50 };
    updateGauges();
    clearFeedback();
    updateRoleUI();
    updateStepChip(0);
    // initial intro text
    scenarioContainerEl.innerHTML = `
      <div class="scenario-title">Welcome to the simulator</div>
      <div class="scenario-meta">Orientation</div>
      <div class="scenario-text">
        When you are ready, select Start or Resume to move into Step 1. You will see one decision at a time with simple options.
        There are no right or wrong answers. The goal is to build a clearer picture of what Phase 1 work can feel like.
      </div>
    `;
  }

  // --------------------------------------------------------------------
  // 8. INITIALIZE AND EVENT LISTENERS
  // --------------------------------------------------------------------

  roleSelectEl.addEventListener("change", () => {
    simState.role = roleSelectEl.value;
    updateRoleUI();
    // re render current scenario with new perspective if not intro
    if (localScenarios[simState.currentScenarioId]) {
      renderScenario(simState.currentScenarioId);
    }
  });

  startBtnEl.addEventListener("click", () => {
    if (simState.currentScenarioId === "intro") {
      renderScenario("intro");
      // move straight into first decision after intro continue
    } else {
      renderScenario(simState.currentScenarioId);
    }
  });

  resetBtnEl.addEventListener("click", () => {
    resetSimulation();
  });

  continueBtnEl.addEventListener("click", () => {
    if (simState.currentScenarioId === "intro") {
      renderScenario("launch");
    } else {
      handleContinue();
    }
  });

  backBtnEl.addEventListener("click", () => {
    handleBack();
  });

  // Start
  updateGauges();
  updateRoleUI();
  updateStepChip(0);
</script>
</body>
</html>
